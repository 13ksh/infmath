<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>점수 차트</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{
      font-family: Arial, sans-serif; margin:0; background:#fff; color:#333;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      height:100vh; padding:40px 0;
    }
    h1{ margin-bottom:20px; font-size:1.8rem; text-align:center }
    #chartContainer{ width:60%; max-width:600px; height:500px }
    canvas{ width:100% !important; height:100% !important }
    #comment{ margin-top:20px; font-size:1rem; color:#555; text-align:center; max-width:600px; line-height:1.5 }
  </style>
</head>
<body>
  <h1 id="title">점수 차트</h1>
  <div id="chartContainer"><canvas id="scoreChart"></canvas></div>
  <p id="comment"></p>
<script>
  // --- 안전한 UTF-8 Base64 디코더 (문제 나면 null 반환) ---
  const tryBase64Decode = (b64) => {
    try {
      if (typeof b64 !== "string" || b64.trim() === "") return null;
      // URL 인코딩 풀기 (d=가 encodeURIComponent 된 상태이므로)
      const decoded = new TextDecoder().decode(
        Uint8Array.from(atob(decodeURIComponent(b64)), c => c.charCodeAt(0))
      );
      return decoded;
    } catch { return null; }
  };

  // --- 점수 문자열을 숫자로 안전 변환: Base64 → 숫자, 또는 그냥 숫자 문자열 → 숫자 ---
  const toNumberSafe = (maybeB64orNum) => {
    // 1) 먼저 Base64 시도
    const asStr = typeof maybeB64orNum === "string" ? maybeB64orNum.trim() : String(maybeB64orNum);
    let decoded = tryBase64Decode(asStr);
    if (decoded !== null) {
      const n = Number(decoded.trim());
      return Number.isFinite(n) ? n : NaN;
    }
    // 2) 실패하면 그냥 숫자 파싱
    const n = Number(asStr.trim());
    return Number.isFinite(n) ? n : NaN;
  };

  const params = new URLSearchParams(location.search);
  let user = "사용자", comment = "", labels = [], scores = [];

  if (params.has("d")) {
    // ===== 새 방식: 전체 payload를 d=Base64(JSON)로 전달 =====
    const jsonText = tryBase64Decode(params.get("d"));
    if (jsonText !== null) {
      try {
        const payload = JSON.parse(jsonText);
        user = (payload.user ?? user) || user;
        comment = (payload.comment ?? "") || "";

        const items = Array.isArray(payload.items) ? payload.items : [];
        labels = [];
        scores = [];

        items.forEach((it, i) => {
          const label = (it && it.label) ? String(it.label).trim() : `점수 ${i+1}`;
          const val = toNumberSafe(it?.score);
          if (Number.isFinite(val)) {  // ★ 유효한 쌍만 반영
            labels.push(label);
            scores.push(val);
          }
        });
      } catch (e) {
        console.warn("payload JSON parse error:", e);
      }
    } else {
      console.warn("d param base64 decode failed");
    }
  } else {
    // ===== 구 방식 호환: ?user=&scorecount=&label1=&score1=... =====
    user = params.get("user") || user;
    comment = params.get("comment") || "";
    const n = Number(params.get("scorecount")) || 0;
    labels = [];
    scores = [];
    for (let i = 1; i <= n; i++) {
      const label = params.get(`label${i}`) || `점수 ${i}`;
      const num = Number(params.get(`score${i}`));
      if (Number.isFinite(num)) {
        labels.push(label);
        scores.push(num);
      }
    }
  }

  // 제목/멘트
  document.getElementById("title").textContent = `${user}님의 점수 차트`;
  if (comment) document.getElementById("comment").textContent = comment;

  // 점수가 하나도 없으면 가드(개발용 메시지)
  if (!scores.length) {
    console.warn("No valid scores parsed. labels=", labels, "scores=", scores);
  }

  // 차트
  new Chart(document.getElementById("scoreChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "점수",
        data: scores,
        backgroundColor: "rgba(54, 162, 235, 0.6)",
        borderColor: "rgba(54, 162, 235, 1)",
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, min: 0, max: 100 } }
    }
  });
</script>
</body>
</html>



